version: '3.8'

services:
  # Registry Docker privado local
  registry:
    image: registry:2
    container_name: ex07-registry
    ports:
      - "5000:5000"
    networks:
      - ci-network

  # Docker-in-Docker (daemon isolado para builds)
  dind:
    image: docker:27-dind
    container_name: ex07-dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""  # Desabilita TLS (apenas para dev local!)
    networks:
      - ci-network

  # AplicaÃ§Ã£o Node.js com testes
  app:
    build: ./app
    container_name: ex07-app
    command: npm test
    networks:
      - ci-network

  # Builder: constrÃ³i e publica SE testes passarem
  builder:
    image: docker:27-cli
    container_name: ex07-builder
    depends_on:
      - dind
      - registry
      - app
    environment:
      DOCKER_HOST: tcp://dind:2375
    volumes:
      - ./app:/workspace
    working_dir: /workspace
    command: >
      sh -c "
        echo 'ğŸ”¨ Aguardando Docker daemon...'
        && sleep 5
        && echo 'ğŸ§ª Executando testes...'
        && docker build -t biblioteca-ci:latest .
        && docker run --rm biblioteca-ci:latest npm test
        && TEST_EXIT=$$?
        && if [ $$TEST_EXIT -eq 0 ]; then
            echo 'âœ… Testes passaram! Publicando imagem...'
            && docker tag biblioteca-ci:latest registry:5000/biblioteca-ci:latest
            && docker push registry:5000/biblioteca-ci:latest
            && echo 'ğŸš€ Imagem publicada com sucesso no registry!'
        else
            echo 'âŒ Testes falharam! Bloqueando publicaÃ§Ã£o.'
            && exit 1
        fi
      "
    networks:
      - ci-network

networks:
  ci-network:
    driver: bridge
